<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VendPlug | Buyer Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #ffffff;
      padding: 20px;
    }

    /* Global Search Styles */
    .search-container {
      max-width: 600px;
      margin: 0 auto 20px;
      position: relative;
    }

    .search-box {
      display: flex;
      background: #1e1e1e;
      border: 2px solid #2c2c2c;
      border-radius: 25px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .search-box:focus-within {
      border-color: #00cc99;
      box-shadow: 0 0 0 3px rgba(0, 204, 153, 0.1);
    }

    .search-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border: none;
      background: transparent;
      color: #ffffff;
      font-size: 0.9rem;
      outline: none;
    }

    .search-input::placeholder {
      color: #6c757d;
    }

    .search-btn {
      padding: 0.75rem 1rem;
      background: #00cc99;
      border: none;
      color: #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      background: #01b488;
    }

    /* Search Suggestions */
    .search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e1e1e;
      border: 2px solid #2c2c2c;
      border-top: none;
      border-radius: 0 0 25px 25px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .suggestion-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #2c2c2c;
      transition: background-color 0.2s ease;
    }

    .suggestion-item:hover {
      background: #2c2c2c;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-product {
      color: #ffffff;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .suggestion-vendor {
      color: #6c757d;
      font-size: 0.875rem;
    }

    h2 {
      color: #00cc99;
      margin-bottom: 20px;
      text-align: center;
    }

    .profile-container {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: 0 auto;
      border: 1px solid #2c2c2c;
    }

    label {
      display: block;
      margin-top: 14px;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 5px;
      border: 1px solid #2c2c2c;
      background: #2c2c2c;
      color: #ffffff;
      font-family: inherit;
    }

    textarea { min-height: 90px; resize: vertical; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
    }

    button {
      margin-top: 20px;
      padding: 10px;
      width: 100%;
      background-color: #00cc99;
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover { background-color: #01b488; }

    .msg { margin-top: 12px; font-size: 0.95em; }
    .msg.success { color: #00ff88; }
    .msg.error { color: #ff5555; }
  </style>
</head>
<body>
  <!-- Global Product Search Bar -->
  <div class="search-container">
    <div class="search-box">
      <input type="text" id="globalSearchInput" placeholder="Search for products across all vendors..." class="search-input">
      <button class="search-btn" onclick="performGlobalSearch()">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <div id="searchSuggestions" class="search-suggestions"></div>
  </div>

  <h2>Buyer Profile</h2>

  <div class="profile-container">
    <div class="row">
      <div>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" />
      </div>
      <div>
        <label for="email">Email</label>
        <input type="email" id="email" disabled />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="phoneNumber">Phone Number</label>
        <input type="text" id="phoneNumber" />
      </div>
      <div>
        <label for="state">State</label>
        <input type="text" id="state" />
      </div>
    </div>

    <label for="address">Address</label>
    <input type="text" id="address" />

    <label for="city">City</label>
    <input type="text" id="city" />

    <label for="about">About (optional)</label>
    <textarea id="about" placeholder="Tell vendors a little about yourself"></textarea>

    <button onclick="updateBuyerProfile()">Save Changes</button>

    <div id="statusMsg" class="msg"></div>
  </div>

  <script src="/js/config.js"></script>
  <script src="/js/auth-utils.js"></script>
  <script src="/js/back-button.js"></script>
  <script>
    const buyer = JSON.parse(localStorage.getItem('vendplugBuyer'));
    const token = getAuthToken();
    const API = (window.BACKEND_URL || '') + '/api/buyers/profile';

    if (!buyer || !token) {
      alert('Unauthorized. Please log in again.');
      window.location.href = '/buyer-auth.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadBuyerProfile();
    });

    function loadBuyerProfile() {
      document.getElementById('fullName').value = buyer.fullName || '';
      document.getElementById('email').value = buyer.email || '';
      document.getElementById('phoneNumber').value = buyer.phoneNumber || '';
      document.getElementById('address').value = buyer.address || '';
      document.getElementById('city').value = buyer.city || '';
      document.getElementById('state').value = buyer.state || '';
      document.getElementById('about').value = buyer.about || '';
    }

    async function updateBuyerProfile() {
      const payload = {
        fullName: document.getElementById('fullName').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        address: document.getElementById('address').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        about: document.getElementById('about').value.trim(),
      };

      try {
        const res = await fetch(API, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        const msg = document.getElementById('statusMsg');
        if (!res.ok) throw new Error(data.message || 'Update failed');

        // Persist new buyer data locally if returned
        if (data.buyer) {
          localStorage.setItem('vendplugBuyer', JSON.stringify(data.buyer));
        } else {
          // Fallback: merge local buyer with payload
          const updated = { ...(buyer || {}), ...payload };
          localStorage.setItem('vendplugBuyer', JSON.stringify(updated));
        }
        msg.textContent = 'âœ… Profile updated successfully';
        msg.className = 'msg success';
      } catch (err) {
        const msg = document.getElementById('statusMsg');
        msg.textContent = err.message;
        msg.className = 'msg error';
      }
    }

    // Global Product Search Functionality
    let searchTimeout;
    const searchInput = document.getElementById('globalSearchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');

    // Search suggestions functionality
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
          // Debounce search requests
          searchTimeout = setTimeout(() => {
            fetchSearchSuggestions(query);
          }, 300);
        } else {
          hideSuggestions();
        }
      });

      // Handle Enter key
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performGlobalSearch();
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
          hideSuggestions();
        }
      });
    }

    async function fetchSearchSuggestions(query) {
      try {
        const response = await fetch(`${window.BACKEND_URL || window.location.origin}/api/products/search?q=${encodeURIComponent(query)}&limit=5`);
        const data = await response.json();
        
        if (data.success && data.products && data.products.length > 0) {
          showSuggestions(data.products);
        } else {
          hideSuggestions();
        }
      } catch (error) {
        console.error('Search suggestions error:', error);
        hideSuggestions();
      }
    }

    function showSuggestions(products) {
      searchSuggestions.innerHTML = '';
      
      products.forEach(product => {
        const suggestionItem = document.createElement('div');
        suggestionItem.className = 'suggestion-item';
        
        const vendorName = product.agent 
          ? (product.agent?.businessName || product.agent?.fullName || 'Unknown')
          : (product.vendor?.shopName || product.vendor?.fullName || 'Unknown');
        
        suggestionItem.innerHTML = `
          <div class="suggestion-product">${product.name}</div>
          <div class="suggestion-vendor">by ${vendorName}</div>
        `;
        
        suggestionItem.addEventListener('click', () => {
          window.location.href = `product-detail.html?id=${product._id}`;
        });
        
        searchSuggestions.appendChild(suggestionItem);
      });
      
      searchSuggestions.style.display = 'block';
    }

    function hideSuggestions() {
      searchSuggestions.style.display = 'none';
    }

    function performGlobalSearch() {
      const query = searchInput.value.trim();
      if (query.length >= 2) {
        window.location.href = `search-results.html?q=${encodeURIComponent(query)}`;
      }
    }
  </script>
</body>
</html>
