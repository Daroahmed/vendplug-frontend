<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Product Details - Vendplug</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/CSS/skeleton.css">
  <script src="/js/config.js"></script>
  <script src="/js/cdn-utils.js"></script>
  <style>
    :root {
      --primary: #00cc99;
      --bg-dark: #0a0a0a;
      --bg-card: #1e1e1e;
      --bg-secondary: #2a2a2a;
      --text-light: #ffffff;
      --muted: #9aa0a6;
      --border: rgba(255,255,255,0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding-top: 60px; /* space for fixed header */
      overflow-x: hidden;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      background: var(--bg-card);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
    }
    .header-title { color: var(--primary); font-weight: 700; font-size: 1.05rem; }

    /* Container */
    .container { max-width: 1000px; margin: 0 auto; padding: 16px; }

    /* Product image */
    .product-image-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    .product-image { width: 100%; height: auto; max-height: 70vh; object-fit: contain; background: #111; border-radius: 8px; display: block; }

    .gallery-thumbnails { display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr)); gap: 10px; margin-top: 10px; }
    .gallery-thumbnail { width: 100%; height: 72px; object-fit: cover; border-radius: 6px; border: 2px solid transparent; background: #111; cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
    .gallery-thumbnail:hover { transform: scale(1.02); border-color: var(--primary); }
    .gallery-thumbnail.active { border-color: var(--primary); }

    /* Product info */
    .product-info { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .product-title { color: var(--primary); font-size: 1.5rem; font-weight: 700; margin-bottom: 8px; }
    .price { color: var(--primary); font-weight: 700; margin-bottom: 8px; font-size: 1.25rem; }
    .description { color: var(--muted); line-height: 1.6; margin: 8px 0 16px; }

    .specs { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .spec-row { display: flex; justify-content: space-between; gap: 12px; padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .spec-row:last-child { border-bottom: none; }
    .spec-label { color: var(--muted); }
    .spec-value { color: var(--text-light); font-weight: 500; text-align: right; }

    /* Vendor card */
    .vendor-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .vendor-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .vendor-avatar { width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: #00110b; font-weight: 800; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .vendor-name { font-size: 1.1rem; font-weight: 700; }
    .vendor-type { color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
    .vendor-location { color: var(--muted); font-size: 0.9rem; }

    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 6px; }
    .stat { text-align: center; }
    .stat-value { color: var(--primary); font-weight: 700; }
    .stat-label { color: var(--muted); font-size: 0.8rem; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; border: 2px solid transparent; cursor: pointer; font-weight: 700; text-decoration: none; transition: all .2s; width: 100%; }
    .btn-primary { background: var(--primary); color: #00110b; }
    .btn-outline { background: transparent; color: var(--primary); border-color: var(--primary); }
    .btn:hover { transform: translateY(-1px); }

    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }
    @media (max-width: 520px) { .actions { grid-template-columns: 1fr; } }

    /* Reviews */
    .reviews-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .section-title { font-size: 1.2rem; color: var(--text-light); margin-bottom: 12px; }
    .review-item { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
    .review-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .review-author { font-weight: 700; }
    .review-rating { color: #ffd54f; font-weight: 700; }
    .no-reviews { color: var(--muted); text-align: center; padding: 16px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">Product Details</div>
  </div>

  <div class="container">
    <!-- Skeleton detail -->
    <div id="skeletonDetail" style="margin-bottom:16px;">
      <div class="skeleton h-200" style="border-radius:12px;"></div>
      <div style="padding:12px 2px;">
        <div class="skeleton-line lg w-80"></div>
        <div class="skeleton-line w-40"></div>
        <div class="skeleton-line w-100"></div>
        <div class="skeleton-line w-80"></div>
      </div>
    </div>

    <div id="loadingSpinner" class="loading" style="text-align:center; padding: 3rem;">
      <div class="spinner" style="width:50px;height:50px;border:5px solid rgba(255,255,255,0.1);border-top:5px solid var(--primary);border-radius:50%;margin:0 auto 10px;animation:spin 1s linear infinite"></div>
      <div style="color:var(--muted)">Loading product details...</div>
    </div>

    <div id="errorMessage" class="error" style="display:none; text-align:center; padding:2rem; color:#ff6b6b;">
      <i class="fas fa-exclamation-triangle" style="font-size:32px"></i>
      <h3>Product not found</h3>
      <p>The product you're looking for doesn't exist or has been removed.</p>
    </div>

    <div id="productContainer" style="display:none;">
      <!-- Product Image Gallery -->
      <div class="product-image-container">
        <img id="productImage" class="product-image" alt="Product Image" onerror="this.src='/assets/placeholder-product.svg'" />
        <div id="galleryThumbnails" class="gallery-thumbnails" style="display:none;"></div>
      </div>

      <!-- Product Info -->
      <div class="product-info">
        <h1 id="productName" class="product-title"></h1>
        <div id="productPrice" class="price"></div>
        <div id="productDescription" class="description"></div>
        <div class="specs">
          <div class="spec-row"><span class="spec-label">Category</span><span id="specCategory" class="spec-value">—</span></div>
          <div class="spec-row"><span class="spec-label">Condition</span><span id="specCondition" class="spec-value">—</span></div>
          <div class="spec-row"><span class="spec-label">Availability</span><span id="specAvailability" class="spec-value">—</span></div>
          <div class="spec-row"><span class="spec-label">Location</span><span id="specLocation" class="spec-value">—</span></div>
        </div>
      </div>

      <!-- Vendor Card -->
      <div class="vendor-card">
        <div class="vendor-header">
          <div id="vendorAvatar" class="vendor-avatar">V</div>
          <div>
            <div id="vendorName" class="vendor-name">Vendor</div>
            <div id="vendorType" class="vendor-type">Vendor</div>
            <div id="vendorLocation" class="vendor-location">—</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat"><div id="vendorRating" class="stat-value">N/A</div><div class="stat-label">Rating</div></div>
          <div class="stat"><div id="vendorTransactions" class="stat-value">0</div><div class="stat-label">Transactions</div></div>
          <div class="stat"><div id="vendorReviewsCount" class="stat-value">0</div><div class="stat-label">Reviews</div></div>
        </div>
        <div class="actions">
          <button id="visitShopBtn" class="btn btn-primary"><i class="fas fa-store"></i> Visit Shop</button>
          <button id="startChatBtn" class="btn btn-outline"><i class="fas fa-comments"></i> Start Chat</button>
        </div>
      </div>

      <!-- Reviews -->
      <div class="reviews-section">
        <h2 class="section-title">Vendor Reviews</h2>
        <div id="reviewsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const spin = document.createElement('style');
    spin.textContent = '@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}';
    document.head.appendChild(spin);

    let productId; let productData;
    document.addEventListener('DOMContentLoaded', () => {
      try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch(_) {}
      const urlParams = new URLSearchParams(window.location.search);
      productId = urlParams.get('id');
      if (productId) loadProduct(); else showError();
    });

    async function loadProduct(){
      showLoading(true);
      try{
        const res = await fetch(`${window.BACKEND_URL || window.location.origin}/api/products/${productId}`);
        const data = await res.json();
        if (data && data.success && data.product) {
          productData = data.product;
          renderProduct(productData);
          await loadVendorReviews();
        } else {
          showError();
        }
      } catch(err){
        console.error('Error loading product:', err);
        showError();
      } finally { showLoading(false); }
    }

    function showLoading(show){
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
      document.getElementById('productContainer').style.display = show ? 'none' : 'block';
      try { document.getElementById('skeletonDetail').style.display = show ? 'block' : 'none'; } catch(_) {}
      document.getElementById('errorMessage').style.display = 'none';
    }
    function showError(){
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('productContainer').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
    }

    function renderProduct(p){
      // Images: primary + gallery
      const imgs = [ ...(p.image ? [p.image] : []), ...(Array.isArray(p.images) ? p.images : []) ].filter(Boolean);
      const unique = Array.from(new Set(imgs));
      const mainSrc = unique[0] || '/assets/placeholder-product.svg';
      const main = document.getElementById('productImage');
      // Prepare blur-up + lazy-upgrade for hero
      try {
        const tiny = (window.blurPlaceholder ? blurPlaceholder(mainSrc, 60) : mainSrc);
        const full = (window.optimizeImage ? optimizeImage(mainSrc, 1200, { crop:'fill' }) : mainSrc);
        const srcset = (window.buildSrcSet ? buildSrcSet(mainSrc, [480,640,800,1200]) : '');
        main.src = tiny;
        main.setAttribute('data-src', full);
        if (srcset) {
          main.setAttribute('data-srcset', srcset);
          main.setAttribute('sizes', '100vw');
        }
        try { main.loading = 'lazy'; } catch(_){}
        try { main.decoding = 'async'; } catch(_){}
      } catch(_){
        main.src = mainSrc;
      }
      const thumbs = document.getElementById('galleryThumbnails');
      thumbs.innerHTML = '';
      if (unique.length > 0) {
        thumbs.style.display = 'grid';
        unique.forEach((src, idx) => {
          const img = document.createElement('img');
          // Thumbnails use tiny blur, upgrade lazily when scrolled into view
          try {
            img.src = (window.blurPlaceholder ? blurPlaceholder(src, 24) : src);
            img.setAttribute('data-src', (window.optimizeImage ? optimizeImage(src, 200, { crop:'fill', height:120 }) : src));
            const sset = (window.buildSrcSet ? buildSrcSet(src, [120,160,200,240]) : '');
            if (sset) { img.setAttribute('data-srcset', sset); img.setAttribute('sizes','(max-width: 480px) 25vw, 120px'); }
            try { img.loading = 'lazy'; } catch(_){}
            try { img.decoding = 'async'; } catch(_){}
          } catch(_){ img.src = src; }
          img.alt = p.name || 'Product';
          img.className = 'gallery-thumbnail' + (idx === 0 ? ' active' : '');
          img.onerror = () => { img.src = '/assets/placeholder-product.svg'; };
          img.addEventListener('click', () => {
            // Switch main image with spinner + blur-up
            try {
              const wrap = main.closest('.img-wrap');
              if (wrap) wrap.classList.remove('loaded');
              main.classList.remove('img-loaded');
              main.src = (window.blurPlaceholder ? blurPlaceholder(src, 60) : src);
              main.setAttribute('data-src', (window.optimizeImage ? optimizeImage(src, 1200, { crop:'fill' }) : src));
              const sset2 = (window.buildSrcSet ? buildSrcSet(src, [480,640,800,1200]) : '');
              if (sset2) { main.setAttribute('data-srcset', sset2); main.setAttribute('sizes', '100vw'); }
              if (window.lazyUpgradeImages) window.lazyUpgradeImages();
            } catch(_) {
              main.src = (window.optimizeImage ? optimizeImage(src, 1200, { crop:'fill' }) : src);
            }
            document.querySelectorAll('.gallery-thumbnail').forEach(t => t.classList.remove('active'));
            img.classList.add('active');
            try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(_) {}
          });
          thumbs.appendChild(img);
        });
      } else {
        thumbs.style.display = 'none';
      }

      // Ensure hero and thumbnails are wrapped and upgraded
      try { if (window.lazyUpgradeImages) window.lazyUpgradeImages(); } catch(_){}

      // Product info
      document.getElementById('productName').textContent = p.name || 'Untitled Product';
      document.getElementById('productPrice').textContent = `₦${(p.price || 0).toLocaleString()}`;
      document.getElementById('productDescription').textContent = p.description || 'No description available';
      document.getElementById('specCategory').textContent = Array.isArray(p.category) ? p.category.join(', ') : (p.category || 'N/A');
      document.getElementById('specCondition').textContent = p.condition || 'New';
      document.getElementById('specAvailability').textContent = p.availability || 'In Stock';
      document.getElementById('specLocation').textContent = 'Loading...';

      // Vendor / Agent
      const vendor = p.vendor || p.agent || {};
      const isAgent = !!p.agent; const vendorType = isAgent ? 'Agent' : 'Vendor';
      const vendorName = isAgent ? (vendor.businessName || vendor.fullName || 'Unknown') : (vendor.shopName || vendor.fullName || 'Unknown');
      document.getElementById('vendorAvatar').textContent = (vendorName || 'V').charAt(0).toUpperCase();
      document.getElementById('vendorName').textContent = vendorName;
      document.getElementById('vendorType').textContent = vendorType;

      const visitBtn = document.getElementById('visitShopBtn');
      visitBtn.onclick = () => {
        if (isAgent) window.location.href = `view-business.html?agent=${vendor._id}`;
        else window.location.href = `view-shop.html?vendor=${vendor._id}`;
      };
      const chatBtn = document.getElementById('startChatBtn');
      chatBtn.onclick = () => startChat(vendor?._id, vendorType, vendorName);

      // Fetch vendor profile for stats/location
      if (vendor && vendor._id) {
        fetch(`${window.BACKEND_URL || window.location.origin}/api/${isAgent ? 'agents' : 'vendors'}/${vendor._id}`)
          .then(r=>r.json())
          .then(v => {
            const rating = v.averageRating || v.rating;
            document.getElementById('vendorRating').textContent = rating ? Number(rating).toFixed(1) : 'N/A';
            document.getElementById('vendorTransactions').textContent = v.totalTransactions || 0;
            document.getElementById('vendorReviewsCount').textContent = (v.reviews && v.reviews.length) || 0;
            const state = v.state || v.businessAddress || 'Location not specified';
            document.getElementById('vendorLocation').textContent = state;
            document.getElementById('specLocation').textContent = state;
          }).catch(()=>{});
      }

      try { window.scrollTo({ top: 0, behavior: 'auto' }); } catch(_) {}

      // SEO: canonical, meta description, JSON-LD Product
      (function(){
        try {
          const PUBLIC_ORIGIN = (window.PUBLIC_URL || window.FRONTEND_URL || window.location.origin);
          // Title
          if (p && p.name) document.title = `${p.name} | VendPlug`;
          // Canonical
          const ensureTag = (sel, create) => document.querySelector(sel) || create();
          const canon = ensureTag('link[rel="canonical"]', () => { const l=document.createElement('link'); l.rel='canonical'; document.head.appendChild(l); return l; });
          canon.href = PUBLIC_ORIGIN + window.location.pathname + window.location.search;
          // Meta description
          const metaDesc = ensureTag('meta[name="description"]', () => { const m=document.createElement('meta'); m.name='description'; document.head.appendChild(m); return m; });
          metaDesc.content = (p.description || `${p.name || 'Product'} on VendPlug`).toString().slice(0,160);
          // JSON-LD Product
          const availability = (p.availability || '').toLowerCase().includes('out') ? 'https://schema.org/OutOfStock' : 'https://schema.org/InStock';
          const images = unique.length ? unique.slice(0,6) : [PUBLIC_ORIGIN + '/assets/placeholder-product.svg'];
          const ld = {
            "@context":"https://schema.org",
            "@type":"Product",
            "name": p.name || 'Product',
            "image": images,
            "description": p.description || '',
            "sku": p._id || '',
            "brand": { "@type":"Brand", "name": vendorName || 'Vendor' },
            "offers": {
              "@type":"Offer",
              "priceCurrency":"NGN",
              "price": String(p.price || ''),
              "availability": availability,
              "url": PUBLIC_ORIGIN + window.location.pathname + window.location.search,
              "itemCondition":"https://schema.org/NewCondition"
            }
          };
          let el = document.getElementById('ld-product');
          if (!el) { el = document.createElement('script'); el.type='application/ld+json'; el.id='ld-product'; document.head.appendChild(el); }
          el.textContent = JSON.stringify(ld);
        } catch(_) {}
      })();
    }

    async function loadVendorReviews(){
      try{
        const vendor = productData.vendor || productData.agent;
        if (!vendor?._id) return;
        const vendorType = productData.vendor ? 'vendors' : 'agents';
        const res = await fetch(`${window.BACKEND_URL || window.location.origin}/api/${vendorType}/${vendor._id}`);
        const data = await res.json();
        const reviews = (data && data.reviews) || [];
        renderReviews(reviews, data.averageRating || data.rating);
      }catch(err){
        renderReviews([], null);
      }
    }

    function renderReviews(reviews, avg){
      const container = document.getElementById('reviewsContainer');
      container.innerHTML = '';
      if (!reviews || reviews.length === 0) {
        container.innerHTML = '<div class="no-reviews">No reviews yet. Be the first to review this vendor!</div>';
        return;
      }
      reviews.slice(0,5).forEach(r => {
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
          <div class="review-header">
            <span class="review-author">${(r.buyer && r.buyer.fullName) || r.buyerName || 'Anonymous'}</span>
            <span class="review-rating">${r.rating} ⭐</span>
          </div>
          <div class="review-comment">${r.comment || r.text || ''}</div>
        `;
        container.appendChild(div);
      });
    }

    async function startChat(participantId, participantType, participantName){
      const buyerToken = localStorage.getItem('vendplug-buyer-token');
      if (!buyerToken) {
        const login = confirm('Please sign in to start a chat. Would you like to sign in now?');
        if (login) window.location.href = 'buyer-auth.html';
        return;
      }
      try{
        const response = await fetch(`${window.BACKEND_URL || window.location.origin}/api/chats`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${buyerToken}` },
          body: JSON.stringify({ participantId, participantType })
        });
        if (response.ok) {
          window.location.href = 'chat.html';
        } else {
          alert('Failed to start chat. Please try again.');
        }
      } catch(err){ alert('Error starting chat. Please try again.'); }
    }
  </script>
</body>
</html>