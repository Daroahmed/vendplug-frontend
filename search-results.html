<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Search Results - Vendplug</title>
  <link rel="stylesheet" href="CSS/skeleton.css">
  <style>
    :root{--primary:#00cc99;--bg:#0a0a0a;--card:#1e1e1e;--muted:#9aa0a6;--border:rgba(255,255,255,.08)}
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{background:var(--bg);color:#fff;font-family:"Segoe UI",Tahoma,Arial,sans-serif;overflow-x:hidden}

    /* Sticky search at very top */
    .sticky-search{position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--border)}
    .search-row{max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;gap:8px}
    .search-box{flex:1;display:flex;background:var(--card);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .search-input{flex:1;padding:10px 12px;border:none;background:transparent;color:#fff;outline:none}
    .search-btn{padding:10px 14px;border:none;background:var(--primary);color:#00110b;font-weight:700;cursor:pointer}

    /* Page container */
    .container{max-width:1000px;margin:0 auto;padding:12px}
    .results-header{margin:8px 0 12px 0}
    .results-header h1{font-size:1.1rem}
    .results-header small{color:var(--muted)}

    /* Filters */
    .filters{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px;margin:0 0 12px}
    .filter-row{display:flex;gap:8px;flex-wrap:wrap}
    .filter-group{display:flex;flex-direction:column;gap:6px;min-width:180px}
    .filter-group label{color:var(--muted);font-size:.9rem}
    .select,.apply-btn{padding:8px 10px;background:#141414;border:1px solid var(--border);color:#fff;border-radius:8px}
    .apply-btn{background:var(--primary);color:#00110b;border-color:transparent;font-weight:700;cursor:pointer}

    /* Grid */
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
    @media(min-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}

    /* Card */
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:180px;object-fit:cover;background:#111;display:block}
    .card-body{padding:10px}
    .name{font-weight:700;margin-bottom:4px}
    .desc{color:var(--muted);font-size:.92rem;margin-bottom:8px}
    .price{color:var(--primary);font-weight:800;margin-bottom:8px}
    .vendor{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.9rem;margin-bottom:10px}
    .avatar{width:28px;height:28px;border-radius:50%;background:var(--primary);color:#00110b;font-weight:800;display:flex;align-items:center;justify-content:center}
    .visit{margin-top:auto;padding:10px;border:none;border-top:1px solid var(--border);background:transparent;color:var(--primary);cursor:pointer}

    .empty{color:var(--muted);text-align:center;padding:24px}
  </style>
</head>
<body>
  <!-- Sticky search -->
  <div class="sticky-search">
    <div class="search-row">
      <div class="search-box">
        <input id="searchInput" class="search-input" placeholder="Search for products..." />
        <button class="search-btn" onclick="performSearch()">Search</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="results-header">
      <h1>Search Results for "<span id="searchQuery"></span>"</h1>
      <small id="resultsCount">Loading...</small>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="categoryFilter">Category</label>
          <select id="categoryFilter" class="select">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="priceFilter">Price Range</label>
          <select id="priceFilter" class="select">
            <option value="">Any Price</option>
            <option value="0-1000">Under ₦1,000</option>
            <option value="1000-5000">₦1,000 - ₦5,000</option>
            <option value="5000-10000">₦5,000 - ₦10,000</option>
            <option value="10000-50000">₦10,000 - ₦50,000</option>
            <option value="50000+">Above ₦50,000</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="vendorTypeFilter">Vendor Type</label>
          <select id="vendorTypeFilter" class="select">
            <option value="">All Types</option>
            <option value="vendor">Vendors</option>
            <option value="agent">Agents</option>
          </select>
        </div>
        <button class="apply-btn" onclick="applyFilters()">Apply Filters</button>
      </div>
    </div>

    <!-- Skeleton while searching -->
    <div id="resultsSkeleton" class="skeleton-grid" style="display:none">
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
      <div class="skeleton-card"><div class="img h-160 skeleton"></div><div class="body"><div class="skeleton-line w-80"></div><div class="skeleton-line w-60"></div></div></div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">No products found</div>
  </div>

  <script>
    let allProducts = []; let filteredProducts = [];

    document.addEventListener('DOMContentLoaded', () => {
      const url = new URL(window.location.href);
      const q = url.searchParams.get('q') || '';
      document.getElementById('searchInput').value = q;
      document.getElementById('searchQuery').textContent = q;

      document.getElementById('searchInput').addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){ performSearch(); }
      });

      if(q) searchProducts(q); else { setCounts(0,0); render([]); }
    });

    function performSearch(){
      const q = document.getElementById('searchInput').value.trim();
      const url = new URL(window.location.href);
      url.searchParams.set('q', q);
      window.history.replaceState({}, '', url);
      document.getElementById('searchQuery').textContent = q;
      searchProducts(q);
    }

    async function searchProducts(query){
      try { document.getElementById('resultsSkeleton').style.display = 'grid'; } catch(_) {}
      try { document.getElementById('grid').style.display = 'none'; } catch(_) {}
      try{
        const res = await fetch(`${window.BACKEND_URL || window.location.origin}/api/products/search?q=${encodeURIComponent(query)}&limit=50`);
        const data = await res.json();
        allProducts = data && data.success ? (data.products || []) : [];
        filteredProducts = [...allProducts];
        loadCategories();
        render(filteredProducts);
      }catch(err){
        console.error('Search error:', err);
        allProducts = filteredProducts = [];
        render([]);
      } finally {
        try { document.getElementById('resultsSkeleton').style.display = 'none'; } catch(_) {}
        try { document.getElementById('grid').style.display = ''; } catch(_) {}
      }
    }

    function render(list){
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      grid.innerHTML = '';
      if(!list || list.length === 0){
        empty.style.display = 'block';
        setCounts(0, allProducts.length);
        return;
      }
      empty.style.display = 'none';
      list.forEach(p=> grid.appendChild(cardFor(p)) );
      setCounts(list.length, allProducts.length);
    }

    function setCounts(count,total){
      document.getElementById('resultsCount').textContent = `Showing ${count} of ${total} products`;
    }

    function cardFor(product){
      const vendor = product.vendor || product.agent || {};
      const vendorName = product.agent ? (vendor.businessName || vendor.fullName || 'Unknown') : (vendor.shopName || vendor.fullName || 'Unknown');
      const div = document.createElement('div'); div.className='card';
      const mainImg = product.image || (Array.isArray(product.images) && product.images[0]) || '/assets/placeholder-product.svg';
      div.innerHTML = `
        <img src="${mainImg}" alt="${product.name}" onerror="this.src='/assets/placeholder-product.svg'" />
        <div class="card-body">
          <div class="name">${product.name || 'Unnamed product'}</div>
          <div class="desc">${product.description || 'No description available'}</div>
          <div class="price">₦${(product.price || 0).toLocaleString()}</div>
          <div class="vendor"><span class="avatar">${(vendorName||'X').charAt(0).toUpperCase()}</span>${vendorName}</div>
          <button class="visit" onclick="event.stopPropagation(); visit('${vendor._id}','${product.agent?'agent':'vendor'}')">Visit ${product.agent?'Business':'Shop'}</button>
        </div>`;
      div.addEventListener('click', ()=> window.location.href = `product-detail.html?id=${product._id}`);
      return div;
    }

    function visit(id,type){
      if(type==='agent') window.location.href = `view-business.html?agent=${id}`;
      else window.location.href = `view-shop.html?vendor=${id}`;
    }

    function loadCategories(){
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '<option value="">All Categories</option>';
      const set = new Set();
      allProducts.forEach(p=>{ if(p.category) set.add(p.category); });
      [...set].forEach(c=>{ const o = document.createElement('option'); o.value=c; o.textContent=c; select.appendChild(o); });
    }

    function applyFilters(){
      const category = document.getElementById('categoryFilter').value;
      const price = document.getElementById('priceFilter').value;
      const type = document.getElementById('vendorTypeFilter').value;
      filteredProducts = allProducts.filter(p=>{
        if(category && p.category !== category) return false;
        if(type){ const t = p.vendor ? 'vendor' : 'agent'; if(t!==type) return false; }
        if(price){
          const val = p.price || 0; const [min,rawMax] = price.split('-');
          const max = rawMax === '+' ? Infinity : parseInt(rawMax,10);
          const minV = parseInt(min||'0',10);
          if(!(val >= minV && val <= max)) return false;
        }
        return true;
      });
      render(filteredProducts);
    }
  </script>
</body>
</html>
